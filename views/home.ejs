<%- include('header') %>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/boxicons/2.1.0/css/boxicons.min.css"
  integrity="sha512-pVCM5+SN2+qwj36KonHToF2p1oIvoU3bsqxphdOIWMYmgr4ZqD3t5DjKvvetKhXGc/ZG5REYTT6ltKfExEei/Q=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.css"
  integrity="sha256-NAxhqDvtY0l4xn+YVa6WjAcmd94N"
/>
<style>
  body {
    margin-top: 20px;
    background-color: #eee;
  }
  .card {
    margin-bottom: 24px;
    box-shadow: 0 2px 3px #e4e8f0;
  }
  .card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 1px solid #eff0f2;
    border-radius: 1rem;
  }
  .avatar-md {
    height: 4rem;
    width: 4rem;
  }
  .rounded-circle {
    border-radius: 50% !important;
  }
  .img-thumbnail {
    padding: 0.25rem;
    background-color: #f1f3f7;
    border: 1px solid #eff0f2;
    border-radius: 0.75rem;
  }
  .avatar-title {
    align-items: center;
    background-color: #3b76e1;
    color: #fff;
    display: flex;
    font-weight: 500;
    height: 100%;
    justify-content: center;
    width: 100%;
  }
  .bg-soft-primary {
    background-color: rgba(59, 118, 225, 0.25) !important;
  }
  a {
    text-decoration: none !important;
  }
  .badge-soft-danger {
    color: #f56e6e !important;
    background-color: rgba(245, 110, 110, 0.1);
  }
  .badge-soft-success {
    color: #63ad6f !important;
    background-color: rgba(99, 173, 111, 0.1);
  }
  .mb-0 {
    margin-bottom: 0 !important;
  }
  .badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 75%;
    font-weight: 500;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.75rem;
  }
  /* Modal styling */
  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }
  .modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    animation: fadeIn 0.4s;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
</style>
<!-- home start  -->
<div class="container">
  <div class="row align-items-center">
    <div class="col-md-6">
      <div class="mb-3">
        <h5 class="card-title">
          Contact List
          <span class="text-muted fw-normal ms-2">(<%=totalUsers%>)</span>
        </h5>
      </div>
    </div>
  </div>
  <div class="row">
    <% if (usersData && usersData.length > 0) { %> <% usersData.forEach(user =>
    { %>
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div>
              <img
                src="https://bootdey.com/img/Content/avatar/avatar1.png"
                alt=""
                class="avatar-md rounded-circle img-thumbnail"
              />
            </div>
            <div class="flex-1 ms-3">
              <h5 class="font-size-16 mb-1">
                <a href="#" class="text-dark"
                  ><%= user.firstName %> <%= user.lastName %></a
                >
              </h5>
              <span class="badge badge-soft-success mb-0"
                ><%= user.profession %></span
              >
            </div>
          </div>
          <div class="mt-3 pt-1">
            <p class="text-muted mb-0">
              <i
                class="mdi mdi-phone font-size-15 align-middle pe-2 text-primary"
              ></i>
              <%= user.phone %>
            </p>
            <p class="text-muted mb-0 mt-2">
              <i
                class="mdi mdi-email font-size-15 align-middle pe-2 text-primary"
              ></i>
              <%= user.email %>
            </p>
            <!-- Add address here if available -->
          </div>
          <div class="d-flex gap-2 pt-4">
            <!-- Edit Button with Pencil Icon -->
            <button
              onclick="openModal(<%= JSON.stringify(user) %>)"
              class="btn btn-primary btn-sm w-50"
            >
              <i class="bx bx-pencil me-1"></i> Edit
            </button>

            <!-- Delete Button with Trash Icon -->
            <button
              type="button"
              class="btn btn-danger btn-sm w-50"
              onclick="confirmDelete('<%= user._id %>')"
            >
              <i class="bx bx-trash me-1"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>
    <% }) %> <% } else { %>
    <p>No usersData found.</p>
    <% } %>
  </div>
</div>
<!-- Pagination Section -->
<div class="row align-items-center pb-4">
  <div class="col-sm-6">
    <p class="mb-sm-0">
      Showing <%= (currentPage - 1) * 10 + 1 %> to <%= Math.min(currentPage *
      10, totalUsers) %> of <%= totalUsers %> entries
    </p>
  </div>
  <div class="col-sm-6">
    <div class="float-sm-end">
      <ul class="pagination mb-sm-0">
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
          <a href="?page=<%= currentPage - 1 %>" class="page-link">
            <i class="bx bx-chevron-left"></i>
          </a>
        </li>
        <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a href="?page=<%= i %>" class="page-link"><%= i %></a>
        </li>
        <% } %>
        <li
          class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>"
        >
          <a href="?page=<%= currentPage + 1 %>" class="page-link">
            <i class="bx bx-chevron-right"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Edit User Information</h2>
    <form id="editForm">
      <input type="hidden" id="userId" name="userId" />

      <!-- First Name (Editable) -->
      <label for="firstName">First Name:</label>
      <input type="text" id="firstName" name="firstName" required /><br />
      <!-- last Name (Editable) -->
      <label for="lastName">last Name:</label>
      <input type="text" id="lastName" name="lastName" required /><br />

      <!-- Email (Non-Editable) -->
      <label for="email">Email:</label>
      <span id="emailText"></span><br />

      <!-- Phone (Editable) -->
      <label for="phone">Phone:</label>
      <input type="text" id="phone" name="phone" required /><br />

      <!-- Profession (Non-Editable) -->
      <label for="profession">Profession:</label>
      <span id="professionText"></span><br />

      <button type="submit">Save Changes</button>
    </form>
  </div>
</div>
<script>
  var modal = document.getElementById("myModal");
  var span = document.getElementsByClassName("close")[0];
  function openModal(userData) {
    console.log(userData);

    document.getElementById("userId").value = userData._id;
    document.getElementById("firstName").value = userData.firstName;
    document.getElementById("lastName").value = userData.lastName;
    document.getElementById("emailText").textContent = userData.email;
    document.getElementById("phone").value = userData.phone;
    document.getElementById("professionText").textContent = userData.profession;
    modal.style.display = "block";
  }
  span.onclick = function () {
    modal.style.display = "none";
  };
  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  };
  document.getElementById("editForm").onsubmit = function (event) {
    event.preventDefault(); // Prevent the form from submitting normally

    const userId = document.getElementById("userId").value;
    const firstName = document.getElementById("firstName").value;
    const lastName = document.getElementById("lastName").value;
    const phone = document.getElementById("phone").value;

    const updatedUser = {
      firstName,
      phone,
      lastName,
    };

    console.log("updated user ", updatedUser);

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/update-user/${userId}`, {
          method: "PUT", // or 'PATCH'
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(updatedUser),
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error("Failed to update user");
            }
          })
          .then((data) => {
            // Update UI with new user data or refresh the list
            console.log("User updated:", data);
            closeModal();
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    });
  };
  function closeModal() {
    var modal = document.getElementById("myModal");
    modal.style.display = "none";
  }

  function confirmDelete(userId) {
    console.log("user id ", userId);

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        console.log("hii");
        fetch(`/delete-user/${userId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error("Failed to update user");
            }
          })
          .then((data) => {
            console.log("User updated:", data);
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    });
  }
</script>

<%- include('footer') %>
